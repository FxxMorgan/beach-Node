<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Gasto | Beach Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" href="../../favicon.ico" type="image/x-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">

    <!-- Bootstrap Core Css -->
    <link href="../../plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- DataTables Css -->
    <link href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css" rel="stylesheet">

    <!-- Waves Effect Css -->
    <link href="../../plugins/node-waves/waves.css" rel="stylesheet" />

    <!-- Animation Css -->
    <link href="../../plugins/animate-css/animate.css" rel="stylesheet" />

    <!-- Custom Css -->
    <link href="../../css/style.css" rel="stylesheet">

    <style>
        body {
            background-color: #f7f9fc;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background-color: #5a6268;
        }

        .container {
            max-width: 1000px;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card">
                    <div class="header">
                        <h2 class="text-center">Registrar Gasto</h2>
                    </div>
                    <div class="body">
                        <form id="gasto-form">
                            <div class="form-group">
                                <label for="local">Nombre del Local</label>
                                <select id="local" class="form-control" required>
                                    <option value="">Seleccione un local</option>
                                    <!-- Las sucursales se añadirán aquí dinámicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tipo">Tipo de Gasto</label>
                                <select id="tipo" class="form-control" required>
                                    <option value="">Seleccione un tipo</option>
                                    <option value="Fijo">Fijo</option>
                                    <option value="Variable">Variable</option>
                                </select>
                            </div>
                            <div class="form-group" id="descripcion-group">
                                <label for="descripcion">Descripción</label>
                                <textarea id="descripcion" class="form-control" rows="3" placeholder="Ingrese una descripción opcional"></textarea>
                            </div>
                            <div class="form-group" id="fijo-group" style="display: none;">
                                <label for="fijo-select">Selecciona un gasto fijo</label>
                                <select id="fijo-select" class="form-control">
                                    <option value="">Seleccione un gasto fijo</option>
                                    <option value="Alquiler">Alquiler</option>
                                    <option value="Sueldos">Sueldos</option>
                                    <option value="Servicios">Servicios</option>
                                    <!-- Agregar más gastos fijos según sea necesario -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monto">Monto</label>
                                <input type="number" id="monto" class="form-control" placeholder="Ingrese el monto del gasto" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Registrar Gasto</button>
                        </form>
                        <button id="back-button" class="btn btn-back mt-3">Volver al Dashboard</button>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="header">
                        <h2 class="text-center">Lista de Gastos</h2>
                    </div>
                    <div class="body">
                        <table id="gastos-table" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Local</th>
                                    <th>Tipo</th>
                                    <th>Monto</th>
                                    <th>Descripción</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="gastos-body">
                                <!-- Los gastos se añadirán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jquery Core Js -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap Core Js -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- DataTables Js -->
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function() {
            const token = localStorage.getItem('authToken'); // Obtener el token del localStorage

            if (!token) {
                alert('No estás autenticado. Por favor, inicia sesión.');
                window.location.href = '/login'; // Redirige al login si no hay token
                return;
            }

            // Obtener los locales de la API
            fetch('/api/sucursales', {
                headers: {
                    'x-auth-token': token,
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Error al obtener sucursales');
                return response.json();
            })
            .then(data => {
                const localSelect = $('#local');
                data.forEach(sucursal => {
                    localSelect.append(`<option value="${sucursal.name}">${sucursal.name}</option>`); // Cambiado 'nombre' a 'name'
                });
            })
            .catch(error => console.error('Error al obtener sucursales:', error));

            const gastosTable = $('#gastos-table').DataTable({
                columns: [
                    { data: 'local' },
                    { data: 'tipo' },
                    { data: 'monto' },
                    { data: 'descripcion' },
                    { data: 'fecha' },
                ]
            });

            $('#tipo').change(function() {
                const tipo = $(this).val();
                if (tipo === 'Fijo') {
                    $('#descripcion-group').hide();
                    $('#fijo-group').show();
                } else {
                    $('#descripcion-group').show();
                    $('#fijo-group').hide();
                }
            });

            $('#gasto-form').on('submit', function(event) {
                event.preventDefault();

                const nuevoGasto = {
                    local: $('#local').val(),
                    tipo: $('#tipo').val(),
                    monto: $('#monto').val(),
                    descripcion: $('#tipo').val() === 'Fijo' ? $('#fijo-select').val() : $('#descripcion').val(),
                };

                fetch('/api/gastos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token,
                    },
                    body: JSON.stringify(nuevoGasto),
                })
                .then(response => {
                    if (response.ok) {
                        alert('Gasto registrado con éxito');
                        $('#gasto-form')[0].reset(); // Reiniciar formulario
                        gastosTable.row.add(nuevoGasto).draw(); // Añadir gasto a la tabla
                    } else {
                        alert('Error al registrar gasto');
                    }
                })
                .catch(error => console.error('Error:', error));
            });

            // Función para cargar los gastos al cargar la página
            function cargarGastos() {
                fetch('/api/gastos', {
                    headers: {
                        'x-auth-token': token,
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error al obtener gastos');
                    return response.json();
                })
                .then(gastos => {
                    gastos.forEach(gasto => {
                        gastosTable.row.add(gasto).draw();
                    });
                })
                .catch(error => console.error('Error al obtener gastos:', error));
            }

            // Cargar los gastos al cargar la página
            cargarGastos();

            $('#back-button').on('click', function() {
                window.location.href = '/dashboard'; // Cambiar a la URL del dashboard
            });
        });
    </script>
</body>

</html>
