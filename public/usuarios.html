<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>Usuarios | Beach Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" href="../../favicon.ico" type="image/x-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <!-- Bootstrap Core Css -->
    <link href="../../plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Waves Effect Css -->
    <link href="../../plugins/node-waves/waves.css" rel="stylesheet" />

    <!-- Animation Css -->
    <link href="../../plugins/animate-css/animate.css" rel="stylesheet" />

    <!-- Custom Css -->
    <link href="../../css/style.css" rel="stylesheet">

    <!-- Responsive Enhancements -->
    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 12px;
            }

            .form-control {
                font-size: 14px;
            }

            .btn {
                font-size: 12px;
            }
        }

        /* Mejorar la apariencia de las tarjetas */
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Mejorar el estilo de las tablas */
        .table thead th {
            background-color: #007bff;
            color: white;
        }

        /* Botones de acción */
        .btn-warning {
            background-color: #ffc107;
            border: none;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-primary {
            background-color: #007bff;
            border: none;
        }

        /* Estilo para tablas responsivas */
        .table-responsive {
            margin: 0 auto;
        }
    </style>
</head>

<body class="theme-red">
    <div class="container-fluid">
        <!-- Crear Nuevo Usuario -->
        <div class="row clearfix mb-4">
            <div class="col-lg-12">
                <div class="card">
                    <div class="header">
                        <h2 class="text-center">Crear Nuevo Usuario</h2>
                    </div>
                    <div class="body">
                        <form id="create-user-form">
                            <div class="form-group">
                                <label for="user-name">Nombre</label>
                                <input type="text" id="user-name" class="form-control" placeholder="Ingrese nombre del usuario" required>
                            </div>
                            <div class="form-group">
                                <label for="user-email">Correo Electrónico</label>
                                <input type="email" id="user-email" class="form-control" placeholder="Ingrese correo electrónico" required>
                            </div>
                            <div class="form-group">
                                <label for="user-password">Contraseña</label>
                                <input type="password" id="user-password" class="form-control" placeholder="Ingrese una contraseña" required>
                            </div>
                            <div class="form-group">
                                <label for="user-role">Rol</label>
                                <select id="user-role" class="form-control">
                                    <option value="Encargado">Encargado</option>
                                    <option value="Jefe de Local">Jefe de Local</option>
                                    <option value="TI">TI</option>
                                    <option value="Dueño">Dueño</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="user-branch">Sucursal</label>
                                <select id="user-branch" class="form-control">
                                    <!-- Las sucursales se cargarán dinámicamente -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Crear Usuario</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Usuarios -->
        <div class="row clearfix">
            <div class="col-lg-12">
                <div class="card">
                    <div class="header">
                        <h2 class="text-center">Listado de Usuarios</h2>
                    </div>
                    <div class="body table-responsive">
                        <table class="table table-hover" id="user-list">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Sucursal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Usuarios se inyectarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar usuarios -->
    <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Editar Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edit-user-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="form-group">
                            <label for="edit-user-name">Nombre</label>
                            <input type="text" id="edit-user-name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-email">Correo Electrónico</label>
                            <input type="email" id="edit-user-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-role">Rol</label>
                            <select id="edit-user-role" class="form-control">
                                <option value="Encargado">Encargado</option>
                                <option value="Jefe de Local">Jefe de Local</option>
                                <option value="TI">TI</option>
                                <option value="Dueño">Dueño</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-user-branch">Sucursal</label>
                            <select id="edit-user-branch" class="form-control">
                                <!-- Las sucursales se cargarán dinámicamente -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Jquery Core Js -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap Core Js -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // Cargar sucursales para los formularios
        function loadBranchesInForm() {
            fetch('/api/sucursales')
                .then(response => response.json())
                .then(data => {
                    const branchSelectCreate = $('#user-branch');
                    const branchSelectEdit = $('#edit-user-branch');
                    branchSelectCreate.empty();
                    branchSelectEdit.empty();

                    data.forEach(branch => {
                        const option = `<option value="${branch._id}">${branch.name}</option>`;
                        branchSelectCreate.append(option);
                        branchSelectEdit.append(option);
                    });
                })
                .catch(error => console.error('Error al cargar sucursales:', error));
        }

        // Función para cargar usuarios
        function loadUsers() {
            fetch('/api/usuarios')
                .then(response => response.json())
                .then(data => {
                    const userList = document.getElementById('user-list').getElementsByTagName('tbody')[0];
                    userList.innerHTML = ''; // Limpiar lista
                    data.forEach(user => {
                        const row = userList.insertRow();
                        row.insertCell(0).textContent = user._id;
                        row.insertCell(1).textContent = user.name;
                        row.insertCell(2).textContent = user.email;
                        row.insertCell(3).textContent = user.role;
                        row.insertCell(4).textContent = user.branch ? user.branch.name : 'No Asignado';
                        const actionsCell = row.insertCell(5);
                        actionsCell.innerHTML = `
                            <button class="btn btn-warning btn-sm" onclick="editUser('${user._id}', '${user.name}', '${user.email}', '${user.role}', '${user.branch ? user.branch._id : ''}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user._id}')">Eliminar</button>
                        `;
                    });
                })
                .catch(error => console.error('Error al cargar usuarios:', error));
        }

        // Crear nuevo usuario
        $('#create-user-form').on('submit', function (event) {
            event.preventDefault();
            const newUser = {
                name: $('#user-name').val(),
                email: $('#user-email').val(),
                password: $('#user-password').val(),
                role: $('#user-role').val(),
                branch: $('#user-branch').val(),
            };

            fetch('/api/usuarios', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(newUser),
            })
                .then(response => {
                    if (response.ok) {
                        alert('Usuario creado con éxito');
                        loadUsers();
                        $('#create-user-form')[0].reset(); // Reiniciar formulario
                    } else {
                        alert('Error al crear usuario');
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Editar usuario
        function editUser(id, name, email, role, branchId) {
            $('#edit-user-id').val(id);
            $('#edit-user-name').val(name);
            $('#edit-user-email').val(email);
            $('#edit-user-role').val(role);
            $('#edit-user-branch').val(branchId);
            $('#editUserModal').modal('show');
        }

        // Guardar cambios en el usuario editado
        $('#edit-user-form').on('submit', function (event) {
            event.preventDefault();
            const updatedUser = {
                name: $('#edit-user-name').val(),
                email: $('#edit-user-email').val(),
                role: $('#edit-user-role').val(),
                branch: $('#edit-user-branch').val(),
            };

            fetch(`/api/usuarios/${$('#edit-user-id').val()}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedUser),
            })
                .then(response => {
                    if (response.ok) {
                        alert('Usuario actualizado con éxito');
                        loadUsers();
                        $('#editUserModal').modal('hide');
                    } else {
                        alert('Error al actualizar usuario');
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Eliminar usuario
        function deleteUser(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                fetch(`/api/usuarios/${id}`, {
                    method: 'DELETE',
                })
                    .then(response => {
                        if (response.ok) {
                            alert('Usuario eliminado con éxito');
                            loadUsers();
                        } else {
                            alert('Error al eliminar usuario');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        $(document).ready(function () {
            loadBranchesInForm();
            loadUsers();
        });
    </script>
</body>

</html>
